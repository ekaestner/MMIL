function epi_brainmask(fname_in,fname_mask,varargin)
%function epi_brainmask(fname_in,fname_mask,[options])
%
% Purpose: create a brain mask from an EPI volume
%
% Required Parameters:
%   fname_in: full path name of mgh/mgz file containing 4D EPI volume
%   fname_mask: full path name of output mask file
%
% Optional Parameters:
%   'forceflag': overwrite existing output files
%     {default = 0}
%
% Created:  08/18/10 by Don Hagler
% Last Mod: 10/27/12 by Don Hagler
%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

if ~mmil_check_nargs(nargin, 1), return; end;
parms = mmil_args2parms(varargin,{...
  'fname_in',fname_in,[],...
  'fname_out',fname_mask,[],...
... % mask creation
  'log_flag',true,[false true],...
  'thresh',0.9,[],... % cumulative probability of log intensity (max is 1)
... % mask fill 1
  'fill1_smooth1',10,[],...
  'fill1_thresh1',0.95,[],...
  'fill1_smooth2',20,[],...
  'fill1_thresh2',0.1,[],...
  'fill1_smooth3',0,[],...
  'fill1_erode_flag',true,[false true],...
...
  'clip_edges_flag',true,[false true],...
  'clip_edges_width',2,[1 10],...
... % mask fill 2
  'fill2_smooth1',20,[],...
  'fill2_thresh1',0.95,[],...
  'fill2_smooth2',20,[],...
  'fill2_thresh2',0.1,[],...
  'fill2_smooth3',20,[],...
  'fill2_thresh3',0,[],...
  'fill2_erode_flag',true,[false true],...
... % final binarization
  'binary_flag',false,[false true],...
... % other
  'forceflag',false,[false true],...
});

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

args = mmil_parms2args(parms);
mmil_quick_brainmask([],args{:});

