function MMIL_Analyze_MEG_Exams(ProjID,varargin)
% function MMIL_Analyze_MEG_Exams(ProjID,[options])
%
% Required Input:
%   ProjID: Project ID string
%     used to to load ProjInfo and StudyInfo from user's home
%       (e.g. '/home/{user}/ProjInfo/MMIL_ProjInfo.csv'
%             '/home/{user}/ProjInfo/{ProjID}/{ProjID}_VisitInfo.csv' )
%     may be empty if StudyInfo and RootDirs are supplied directly
%
% Optional Parameters:
%  'StudyInfo': struct array containing info for each subject
%    StudyInfo allows this function to find the relevant MEG and MRI data
%    Must have 'MEG_VisitID' to indicate name of the orig_meg data directory
%    Use 'STRUCT_VisitID' to specify MRI session used for FreeSurfer recon
%    Use 'VisitID' to specify MRI session with fMRI retinotopy
%    If empty, will use ProjID to get StudyInfo
%    {default = []}
%  'RootDirs': struct containing locations of root data dirs
%    must include these fields: proc_meg, fsurf
%      (e.g. define in MMIL_ProjInfo.csv)
%    If both RootDirs and StudyInfo are supplied,
%      MMIL_ProjInfo.csv is not required
%    {default = []}
%  'qcflag': [0|1] whether to exclude subjects with StudyInfo.QC=0
%    {default = 0}
%  'batchname': name of ougtput batchdir
%    {default = 'MMIL_Analyze_MEG_Exams'}
%  'batch_append_flag': [0|1] add jobs to existing batchdir
%     otherwise delete any existing jobs
%    {default = 0}
%  'batch_msg_flag': [0|1] display message after creating jobs
%     instructing user to submit jobs to cluster
%    {default = 1}
%  'forceflag': [0|1] overwrite existing output
%    {default = 0 }
%
% Optional Control Parameters:
%  'dSPMflag': [0|1] run Dynamic Statistical Parametric Mapping
%    {default = 1}
%  'dSROIflag': [0|1] run dSPM ROI analysis
%    {default = 1}
%  'RCSEflag': [0|1] run Retinotopy Constrained Source Estimation
%    {default = 0}
%  'dSRCflag': [0|1] run dSPM on RCSE
%                    Error, Fit, or SSP (signal-space projection)
%    {default = 0}
%  'SRCflag': [0|1] synthesize sensor data from RCSE
%                    Error, Fit, or SSP (signal-space projection)
%    {default = 0}
%
% Optional dSPM Parameters (see ts_dSPM for complete list with details):
%  'dSPM_prefix': prefix of dSPM output files
%    {default = 'dSPM'}
%  'dSPM_proc_prefix': prefix of processing output files (must exist already)
%    {default = 'proc'}
%  'dSPM_proc_infix': infix of input processed MEG files
%     e.g. [], 'combcond', 'subnull'
%     {default = []}
%  'dSPM_ico': icosahedral order for resampled FreeSurfer recon
%    If 0, use native surface
%    {default = 4}
%  'dSPM_conditions': vector of condition numbers to analyze
%     {default = []} (if empty, use all conditions found in avg_data.averages)
%  'dSPM_ncov_type': type of noise covariance matrix
%     0 = identity matrix, 1 = average prestimulus, 2 = single trials
%     {default = 2}
%  'dSPM_SNR': estimated signal-to-noise-ratio (for regularization parameter)
%     {default = 10}
%  'dSPM_transfile': text file containing 4x4 mri2head transformation
%     either full path or relative to ContainerPath
%     {default = 'mri2head.trans'}
%  'dSPM_badchanfile': name of text file containing bad channel labels
%     full path or relative to ContainerPath
%     {default = 'badchans.txt'}
%  'dSPM_usegrad_flag': [1|0] whether to use gradiometer data, if available
%     {default = 1}
%  'dSPM_usemag_flag': [1|0] whether to use magnetometer data, if available
%     {default = 1}
%  'dSPM_useEEG_flag': [1|0] whether to use EEG data, if available
%     {default = 0}
%  'dSPM_forward_only_flag': [0|1] calculate forward solution and quit
%     {default = 0}
%  'dSPM_forceflag': [0|1|2] whether to overwrite existing output
%     0: do nothing if output exists
%     1: overwrite results and other output
%     2: overwrite all output, including forward solution
%    {default = 0}
%
% Optional dSPM ROI Parameters
%  (see ts_roi_analysis for complete list with details):
%  'dSROI_conditions': vector or cell array of conditions to analyze
%    If empty, use all stc files found in indir
%    {default: []}
%  'dSROI_outdir': output directory, relative to ContainerPath
%    {default: 'dSROI_analysis'}
%  'dSROI_outstem': output file stem
%    {default: 'dSROI_results'}
%  'dSROI_subjname': name of FreeSurfer subject with label files (ROIs)
%    {default = fsaverage}
%  'dSROI_subjdir': FreeSurfer root directory containing subjname
%    If empty, will use RootDirs.fsurf or RootDirs.fsico (depends on dSPM_ico)
%    {default = []}
%  'dSROI_roidir': directory containing label files
%    full path or relative to subjdir/subjname
%    {default = 'label'}
%  'dSROI_ico': icosahedron order number:
%     If 0, assumes stcfiles are in native subject vertices
%    {default: 4}
%  'dSROI_roinames': cell array of ROI names (FreeSurfer label format)
%      If empty, will search for label files in subjdir/subjname/label
%        with this format: <hemi>.<roiname>.label
%      If none found, will quit with error
%    {default: []}
%  'dSROI_ico_infix_flag':[0|1] if ico>4, expect label files to have
%    this format: <hemi>.<roiname>.ico<ico>.label
%    {default: 0}
%  'dSROI_overlay_roi_flag' [0|1] plot with ROIs overlayed on same plot
%    {default: 0}
%  'dSROI_plot_type': 'jpeg' or 'epsc'  or {'jpeg','epsc'}
%    {default: 'jpeg'}
%  'dSROI_plot_xlim': x axis (time) plot limits (vector of min/max)
%    {default: []}
%  'dSROI_plot_ylim' y axis (amplitude) plot limits (vector of min/max)
%    {default: []}
%  'dSROI_plot_offset': subtract this value from plotted waveforms
%    {default: 1}
%  'dSROI_forceflag': [0|1] overwrite existing output
%    {default: 0}
%
% Optional RCSE Parameters (see rc_RCSE for complete list with details):
%  'RCSE_prefix': prefix of RCSE output files
%    {default = 'RCSE'}
%  'RCSE_proc_prefix': prefix of processing output files (must exist already)
%    {default = 'proc'}
%  'RCSE_proc_infix': infix of input processed MEG files
%     e.g. [], 'combcond', 'subnull'
%     {default = []}
%  'RCSE_infix': additional string attached to output prefix
%     e.g. to indicate values of key parameters
%     {default = []}
%  'RCSE_infix_flag': [0|1] attach automatically generated string
%     indicating values of certain parameters
%     ignored if 'infix' is not empty
%     {default = 0}
%  'RCSE_transfile': text file containing 4x4 mri2head transformation
%     either full path or relative to ContainerPath
%     {default = 'mri2head.trans'}
%  'RCSE_badchanfile': name of text file containing bad channel labels
%     full path or relative to ContainerPath
%     {default = 'badchans.txt'}
%  'RCSE_inverse_type': [0|1|2] type of inverse calculations
%    0: unregularized pseudo-inverse (fast, very little memory)
%    1: regularized psuedo-inverse with identity matrix for noise covariance
%       no source covariance matrix (fast, very little memory)
%    2: regularized psuedo-inverse with noise covariance matrix from data
%       depending on ncov_type, uses source covariance matrix
%    {default = 1}
%  'RCSE_ncov_type': specify what type of noise covariance matrix to use
%     if 0, use identity matrix
%       (assume uniform white noise, independently scaled for each sensor type)
%     if 1, calculate and use noise covariance matrix from average prestim
%     if 2, use noise covariance matrix calculated from single trials
%       (stored in avg_data.noise.covar)
%    {default = 1}
%  'RCSE_SNR': estimated signal-to-noise-ratio (for regularization parameter)
%     {default = 10}
%  'RCSE_usegrad_flag': [1|0] whether to use gradiometer data, if available
%     {default = 1}
%  'RCSE_usemag_flag': [1|0] whether to use magnetometer data, if available
%     {default = 1}
%  'RCSE_useEEG_flag': [1|0] whether to use EEG data, if available
%     {default = 0}
%  'RCSE_retfit_dir': directory containing retfit results
%    relative to fMRI retinotopy ContainerPath (defined by VisitID)
%    {default = 'retfit'}
%  'RCSE_retfit_stem': file stem for refit results
%    {default = 'retfit'}
%  'RCSE_forward_matfile': mat file containing gain matrix
%     If does not exist, will calculate
%     {default: []}
%  'RCSE_use_areas': vector of visual area indices to include in forward model
%    If empty, use all areas specified in retfit results
%    {default = []}
%  'RCSE_r_max': maximum radius (deg vis. angle) used for eccentricity mapping
%    {default = 12.5}
%  'RCSE_rf_sizes': vector of receptive field sizes for each visual area
%    {default = [0.66,1.03,1.88]}
%  'RCSE_rf_slopes': vector of slopes of linear trend of receptive field sizes
%    {default = [0.06,0.10,0.15]}
%  'RCSE_rf_r_inter': radius value used as intercept at which rf size is rf_sizes
%    {default = 6}
%  'RCSE_SNR': estimated signal-to-noise-ratio (for regularization parameter)
%     {default = 10}
%  'RCSE_plotflag': [0|1|2|3] whether to plot source waveforms and residual error
%     0=no plots
%     1=save plots at end (do not display)
%     2=display plots during offset and nbrhd fitting (do not save)
%     3=do not run RCSE, only save plots from previous run (do not display)
%     {default = 0}
%  'RCSE_fstem_conds': stem of csv file containing condition information
%    {default = 'cond_info'}
%  'RCSE_conditions': vector of condition numbers to analyze
%     {default = []} (if empty, use all conditions found in avg_data.averages)
%  'RCSE_hemivec':  vector of hemifield indices (1=right, 2=left)
%    {default = [1 2]}
%  'RCSE_uplowvec': vector of upper or lower field indices (1=upper, 2=lower)
%    {default = [1 2]}
%  'RCSE_eccvec': vector of eccentricity level indices (1=perifoveal, N=peripheral)
%    If empty, use all available
%    {default = []}
%  'RCSE_thetavec': vector of "theta" (polar angle) indices (1=>0, N=<360)
%    If empty, use all available
%    {default = []}
%  'RCSE_contvec': vector of contrast level indices (e.g. [1,2,3])
%    If empty, use all available contrast levels
%    {default = []}
%  'RCSE_sfvec': vector of spatial frequency level indices (e.g. [1,2,3])
%    If empty, use all available spatial frequency levels
%    {default = []}
%  'RCSE_tfvec': vector of temporal frequency level indices (e.g. [1,2,3])
%    If empty, use all available temporal frequency levels
%    {default = []}
%  'RCSE_colvec': vector of color type indices (e.g.[1,2,3])
%    If empty, use all available color types
%    {default = []}
%  'RCSE_prior_prefix': prefix of output files from a previous run of RCSE
%     The prior source waveforms will be used as a reference.
%     For offset or nbrhd search, cost function will be correlation with reference
%       between corr_time0 and corr_time1.
%     Note: only applicable if offset_niters>0 or nbrhd_niters>0
%     {default: []}
%  'RCSE_corr_time0': start of time range (msec) (for prior_prefix)
%     {default: 0}
%  'RCSE_corr_time1': end of time range (msec) (for prior_prefix)
%     {default: 170}
%  'RCSE_err_prefix': prefix of output files from a previous run of RCSE
%     If supplied, will fit residual error from previous run
%     {default: []}
%  'RCSE_offset_niters': number of iterations for random offset search to fit data
%     This tests neighboring vertices, defined by retmap from retfit or w files,
%     to see if they give a better fit to the data
%     If 0, do exhaustive search of offsets
%       specified by all combinations of r_offset and th_offset vectors
%     {default: 0}
%  'RCSE_grid_offset_flag': instead of r and th, make offets to grid
%    coordinates u and v (unit grid)
%    {default = 1}
%  'RCSE_r_step': standard deviation of gaussian step size for rand offset search
%    {default = 0.02}
%  'RCSE_th_step': standard deviation of gaussian step size for rand offset search
%    {default = 0.02}
%  'RCSE_r_offset_range': vector of min and max r_offsets for rand offset search
%    If 0, no bounds
%    {default = [-0.2,0.2]}
%  'RCSE_th_offset_range': vector of min and max th_offsets for rand offset search
%    If 0, no bounds
%    {default = [-0.2,0.2]}
%  'RCSE_group_prior_flag': [0|1] use Group RCSE results as prior
%    {default = 0}
%  'RCSE_group_prior_prefix': prefix of Group RCSE results
%    relative to ~/MetaData/ProjID
%    {default = 'GroupRCSE/RCSE'}
%  'RCSE_group_prior_niters': number of offset search iterations for group prior
%    only used if RCSE_offset_niters = 0
%    {default = 500}
%  'RCSE_group_prior_ProjID': ProjID of Group RCSE results
%    {default = ProjID}
%  'RCSE_forceflag': [0|1|2] whether to overwrite files
%     0: do nothing if output exists
%     1: overwrite results and other output
%     2: overwrite all output, including forward solution
%     {default = 0}
%
% Optional dSPM-RCSE Parameters (see rc_dSPM_RCSE for complete list with details):
%  'dSRC_prefix': prefix of dSPM-RCSE output files
%     {default = 'dSPM_RCSE'}
%  'dSRC_dSPM_prefix': prefix of ts_dSPM output files
%     {default = 'dSPM'}
%  'dSRC_RCSE_prefix': prefix of RCSE output files for source waveforms
%     {default = 'RCSE'}
%  'dSRC_RCSE_rootdir': directory containing matfiles dir for RCSE sources
%     If empty, rootdir
%     {default = ContainerPath}
%  'dSRC_RCSE_forward_prefix': prefix of RCSE output files for forward solution
%     If empty, RCSE_prefix
%     {default = []}
%  'dSRC_fiterr_flag': [0|1|2|3] which type of sensor data
%    0: run dSPM on RCSE fitted data plus noise
%    1: run dSPM on residual error of RCSE fit
%    2: run dSPM on RCSE fit projected into sensor data
%    3: run dSPM on data minus RCSE fit projected into sensor data
%     {default = 0}
%  'dSRC_areas': when fiterr_flag=0, use only these area numbers
%    if empty, use all areas
%    {default = []}
%  'dSRC_conditions': vector of condition numbers (index to avg_data.averages)
%     {default = []}
%  'dSRC_sourcefact': amplitude of modeled sources
%     {default = 1}
%  'dSRC_baselineflag': [0|1] use repeated baseline as noise added to synth_data
%     {default = 1}
%  'dSRC_save_synth_flag': [0|1] save synthesized sensor data to mat file
%     {default = 0}
%  'dSRC_fif_flag': [0|1] save synthesized sensor data to fif file
%     {default = 0}
%  'dSRC_template_fif': template fif file (e.g. raw or online avg)
%     Required for saving synthesized data to fif file
%     {default = []}
%  'dSRC_write_mgh_flag': [0|1] save output maps as mgh files
%     {default = 0}
%  'dSRC_ncov_type': type of noise covariance matrix
%     0 = identity matrix, 1 = average prestimulus, 2 = single trials
%     {default = 2}
%  'dSRC_calc_scalefacts_flag': [0|1] calculate scaling factors
%     {default = 0}
%  'dSRC_forceflag': [0|1] whether to overwrite existing output
%     {default = 0}
%
% Optional Synth-RCSE Parameters (see MEG_MMIL_Synth_RCSE for detailed list)
%  'SRC_outstem': prefix of output files
%     {default = synth_RCSE}
%  'SRC_prefix': prefix of RCSE files to be used
%    {default = 'RCSE'}
%  'SRC_forward_prefix': prefix of RCSE output files with different forward
%    If empty, use prefix
%    {default = []}
%  'SRC_fiterr_flag': which type of sensor data
%    0: RCSE fitted data plus noise
%    1: residual error of RCSE fit
%    2: RCSE fit projected into sensor data plus noise
%    3: data minus RCSE fit projected into sensor data
%     {default = 0}
%  'SRC_areas': when fiterr_flag=0, use only these area numbers
%    if empty, use all areas
%    {default = []}
%  'SRC_sourcefact': amplitude of modeled sources
%    {default = 1}
%  'SRC_baselineflag': [0|1] use repeated baseline as noise added to synth_data
%    {default = 0}
%  'SRC_sources': matrix of source time courses
%     if empty, will use RCSE estimated source time courses
%     size must be [ntpoints,narea,ncontrasts]
%     only used if fiterr_flag = 0
%    {default = []}
%  'SRC_fif_flag': [0|1] save synthesized sensor data to fif file
%     {default = 0}
%  'SRC_template_fif': template fif file (e.g. raw or online avg)
%     Required for saving synthesized data to fif file
%     {default = []}
%  'SRC_conditions': vector of condition numbers (index to avg_data.averages)
%     to be saved as fif files
%     {default = []}
%  'SRC_forceflag': [0|1] whether to overwrite existing output
%     {default = 0}
%
% Created:  02/21/11 by Don Hagler
% Last Mod: 08/23/16 by Don Hagler
%

%% todo: add VESTAL

%% todo: keep?
%  'dSRC_event_codes': vector of event codes to use
%     {default = []}

if ~mmil_check_nargs(nargin,1), return; end;
parms_filter = {...
  'StudyInfo',[],[],...
  'RootDirs',[],[],...
  'qcflag',false,[false true],...
  'batchname','MMIL_Analyze_MEG_Exams',[],...
  'batch_append_flag',false,[false true],...
  'batch_msg_flag',true,[false true],...
  'forceflag',false,[false true],...
  'dSPMflag',true,[false true],...
  'dSROIflag',true,[false true],...
  'RCSEflag',false,[false true],...
  'dSRCflag',false,[false true],...
  'SRCflag',false,[false true],...
... % dSPM options
  'dSPM_prefix','dSPM',[],...
  'dSPM_proc_prefix','proc',[],...
  'dSPM_proc_infix',[],[],...
  'dSPM_ico',4,[0:7],...
  'dSPM_conditions',[],[],...
  'dSPM_calc_dipinfo_flag',true,[false true],...
  'dSPM_lh_dip_info',[],[],...
  'dSPM_rh_dip_info',[],[],...
  'dSPM_lh_dip_file','bem/lh_white.dip',[],...
  'dSPM_rh_dip_file','bem/rh_white.dip',[],...
  'dSPM_nodec_flag',false,[false true],...
  'dSPM_lh_dec_dips',[],[],...
  'dSPM_rh_dec_dips',[],[],...
  'dSPM_lh_dec_file','bem/lh_white_7.dec',[],...
  'dSPM_rh_dec_file','bem/rh_white_7.dec',[],...
  'dSPM_ncov_type',2,[0 2],...
  'dSPM_ncov_conditions',[],[],...
  'dSPM_calc_scalefacts_flag',false,[false true],...
  'dSPM_baseline_start',-Inf,[-Inf Inf],...
  'dSPM_baseline_end',0,[-Inf Inf],...
  'dSPM_baseline_flag',true,[false true],...
  'dSPM_ssp_projmat',[],[],...
  'dSPM_SNR',10,[eps Inf],...
  'dSPM_noisenorm_flag',true,[false true],...
  'dSPM_noisenorm_identity_flag',true,[false true],...
  'dSPM_depthweight_flag',false,[false true],...
  'dSPM_depthweight_p',0.7,[0,1],...
  'dSPM_bem_flag',true,[false true],...
  'dSPM_openmeeg_flag',false,[false true],...
  'dSPM_radii',[],[],...
  'dSPM_conductivities',[0.3 0.012 0.3],[],...
  'dSPM_EEG_gain_scalefact',1,[-Inf Inf],...
  'dSPM_badchans',[],[],...
  'dSPM_badchanfile','badchans.txt',[],...
  'dSPM_usegrad_flag',true,[false true],...
  'dSPM_usemag_flag',true,[false true],...
  'dSPM_useEEG_flag',false,[false true],...
  'dSPM_grad_scalefact',10^13,[-Inf Inf],...
  'dSPM_mag_scalefact',10^15,[-Inf Inf],...
  'dSPM_EEG_scalefact',10^6,[-Inf Inf],...
  'dSPM_write_stc_flag',true,[false true],...
  'dSPM_stc_scalefact',1,[eps Inf],...
  'dSPM_write_mgh_flag',true,[false true],...
  'dSPM_sparsesmooth',0,[0 1000],...
  'dSPM_postsmooth',0,[0 1000],...
  'dSPM_mbmask_flag',false,[false,true],...
  'dSPM_resamp2ico_flag',false,[false true],...
  'dSPM_icolevel',7,[1 7],...
  'dSPM_icosmooth',3,[0 1000],...
  'dSPM_write_fif_flag',false,[false true],...
  'dSPM_template_fif',[],[],...
  'dSPM_nlayers',1,[1:4],...
  'dSPM_bem_surf_files',...
    {'bem/inner_skull.tri','bem/outer_skull.tri','bem/outer_scalp.tri'},[],...
  'dSPM_cen_sph',[],[],...
  'dSPM_trans',[],[],...
  'dSPM_transfile','mri2head.trans',[],...
  'dSPM_alignment_fif',[],[],...
  'dSPM_lh_sourcecov_file',[],[],...
  'dSPM_rh_sourcecov_file',[],[],...
  'dSPM_sourcecov_thresh',0,[-Inf Inf],...
  'dSPM_sourcecov_thresh_abs_flag',true,[false true],...
  'dSPM_sourcecov_maxvar',0.9,[0 1],...
  'dSPM_sourcecov_minvar',0.09,[0 1],...
  'dSPM_forward_matfile',[],[],...
  'dSPM_inverse_matfile',[],[],...
  'dSPM_refEEG_coords',[],[],...
  'dSPM_prewhiten_flag',false,[false true],...
  'dSPM_orient_constr_flag',false,[false true],...
  'dSPM_orient_tang',0,[0 1],...
  'dSPM_smooth_constr_flag',false,[false true],...
  'dSPM_smooth_constr_nsmooth',10,[1,100],...
  'dSPM_signed_sources_flag',true,[false true],...
  'dSPM_datatype','single',{'single','double'},...
  'dSPM_save_results_flag',true,[false true],...
  'dSPM_save_avg_flag',false,[false true],...
  'dSPM_save_fiterr_flag',false,[false true],...
  'dSPM_forward_only_flag',false,[false true],...
  'dSPM_forceflag',0,[0:2],...
  'dSPM_ico_FSContainerPath',[],[],...
... % dSPM ROI options
  'dSROI_indir','stcfiles',[],...
  'dSROI_prefix',[],[],...
  'dSROI_conditions',[],[],...
  'dSROI_outdir','dSROI_analysis',[],...
  'dSROI_outstem','dSROI_results',[],...
  'dSROI_roidir','label',[],...
  'dSROI_subjname','fsaverage',[],...
  'dSROI_subjdir',[],[],...
  'dSROI_ico',[],[0:7],...
  'dSROI_roinames',[],[],...
  'dSROI_ico_infix_flag',false,[false true],...
  'dSROI_overlay_roi_flag',false,[false true],...
  'dSROI_hemilist',{'lh','rh'},{'lh','rh'},...
  'dSROI_plotflag',true,[false true],...
  'dSROI_condnames',[],[],...
  'dSROI_prenames',[],[],...
  'dSROI_plot_type','jpeg',{'jpeg','epsc'},...
  'dSROI_plot_xlim',[],[],...
  'dSROI_plot_ylim',[],[],...
  'dSROI_plot_offset',1,[-Inf,Inf],...
  'dSROI_visible_flag',false,[false true],...
  'dSROI_linewidth',1.5,[],...
  'dSROI_fontname','Arial',[],...
  'dSROI_fontsize',12,[],...
  'dSROI_label_flag',true,[false true],...
  'dSROI_units','sqrt(F)-1',[],...
  'dSROI_roi_colors',{'b','c','g','y','r','m','k'},[],...
  'dSROI_roi_linewidths',[],[],...
  'dSROI_legend_flag',true,[false true],...
  'dSROI_legend_loc','NorthEastOutside',[],...
  'dSROI_avg_hemis_flag',false,[false true],...
  'dSROI_forceflag',false,[false true],...
... % RCSE options
  'RCSE_prefix','RCSE',[],...
  'RCSE_proc_prefix','proc',[],...
  'RCSE_proc_infix',[],[],...
  'RCSE_infix',[],[],...
  'RCSE_infix_flag',false,[false true],...
  'RCSE_transfile','mri2head.trans',[],...
  'RCSE_forceflag',0,[0:2],...
  'RCSE_plotflag',0,[0 1 2 3],...
  'RCSE_badchanfile','badchans.txt',[],...
  'RCSE_forward_matfile',[],[],...
  'RCSE_indy_locs_flag',false,[false true],...
  'RCSE_graymid_flag',false,[false true],...
  'RCSE_calc_dipinfo_flag',true,[false true],...
  'RCSE_inverse_type',1,[0:2],...
  'RCSE_ncov_type',1,[0,1,2],...
  'RCSE_SNR',10,[eps Inf],...
  'RCSE_fstem_conds','cond_info',[],...
  'RCSE_conditions',[],[],...
  'RCSE_cond_offsets_flag',0,[0 1 2],...
  'RCSE_hemivec',[1,2],[1,1,2],...
  'RCSE_uplowvec',[1,2],[1,1,2],...
  'RCSE_eccvec',[],[],...
  'RCSE_thetavec',[],[],...
  'RCSE_contvec',[],[],...
  'RCSE_sfvec',[],[],...
  'RCSE_tfvec',[],[],...
  'RCSE_colvec',[],[],...
  'RCSE_retfit_dir','retfit',[],...
  'RCSE_retfit_stem','retfit',[],...
  'RCSE_vf2ctx_flag',true,[false true],...
  'RCSE_stim_type',2,[0:2],...
  'RCSE_use_areas',[],[],...
  'RCSE_r_offset',0,[-100,100],...
  'RCSE_th_offset',0,[-180,180],...
  'RCSE_r_max',12.5,[0,Inf],...
  'RCSE_ecc_width',1,[0,100],...
  'RCSE_theta_width',10,[0,360],...
  'RCSE_w_thresh',0.01,[0,100],...
  'RCSE_vfnorm_flag',true,[false true],...
  'RCSE_w_thresh_patch',0,[0,1],...
  'RCSE_single_vertex_flag',0,[0 1 2],...
  'RCSE_rf_sizes',[0.66,1.03,1.88],[0.01,10],...
  'RCSE_rf_slopes',[0.06,0.10,0.15],[0,10],...
  'RCSE_rf_r_inter',6,[0,Inf],...
  'RCSE_restrict_hemi_flag',false,[false true],...
  'RCSE_restrict_uplow_flag',false,[false true],...
  'RCSE_restrict_flag',false,[false true],...
  'RCSE_retfit_data_flag',false,[false true],...
  'RCSE_polarity_penalty',0,[-Inf,Inf],...
  'RCSE_fit_range_flag',false,[false true],...
  'RCSE_fit_time0',80,[-Inf,Inf],...
  'RCSE_fit_time1',120,[-Inf,Inf],...
  'RCSE_fmincon_flag',false,[false true],...
  'RCSE_offset_niters',0,[0,Inf],...
  'RCSE_max_offset_niters',Inf,[0,Inf],...
  'RCSE_offset_mstarts',0,[0,Inf],...
  'RCSE_mstart_rotsearch_flag',false,[false true],...
  'RCSE_mstart_rfsearch_flag',false,[false true],...
  'RCSE_mstart_randstart_flag',true,[false true],...
  'RCSE_mstart_average_flag',true,[false true],...
  'RCSE_reweight_flag',true,[false true],...
  'RCSE_reweight_factor',2,[],...
  'RCSE_reweight_maxiter',100,[],...
  'RCSE_reweight_tol',1e-7,[],...
  'RCSE_reweight_leverage_flag',true,[false true],...
  'RCSE_reweight_leverage_max_flag',true,[false true],...
  'RCSE_hybrid_flag',false,[false true],...
  'RCSE_hybrid_pre_niters',0,[0,Inf],...
  'RCSE_offset_niters_last',0,[0,Inf],...
  'RCSE_offset_group_flag',1,[0 1 2 3 4],...
  'RCSE_offset_group_patches_flag',false,[false true],...
  'RCSE_offset_group_areas_flag',false,[false true],...
  'RCSE_offset_const_areas',[],[],...
  'RCSE_r_step',0.02,[1e-4,10],...
  'RCSE_th_step',0.02,[1e-4,90],...
  'RCSE_r_offset_range',[-0.2,0.2],[-100,100],...
  'RCSE_th_offset_range',[-0.2,0.2],[-180,180],...
  'RCSE_grid_offset_flag',true,[false true],...
  'RCSE_grid_offset_smooth',0,[0,1000],...
  'RCSE_rot_niters',0,[0,Inf],...
  'RCSE_rot_step',1,[0,180],...
  'RCSE_rot_max',10,[0,180],...
  'RCSE_best_rot',[0 0 0],[-180 180],...
  'RCSE_rscale_niters',0,[0,Inf],...
  'RCSE_rscale_step',0.01,[0,1],...
  'RCSE_rscale_range',[0.8,1.2],[0.1,10],...
  'RCSE_best_rscale',1,[0.1,10],...
  'RCSE_nbrhd_niters',0,[0,Inf],...
  'RCSE_nbrhd_full_flag',false,[false true],...
  'RCSE_prior_prefix',[],[],...
  'RCSE_prior_weight',0.5,[0,1],...
  'RCSE_prior_avg_flag',0,[0:3],...
  'RCSE_prior_mindiff_flag',0,[0 1 2],...
  'RCSE_prior_zscore_flag',false,[false true],...
  'RCSE_prior_sem_min',0.5,[eps,100],...
  'RCSE_prior_indy_wform_flag',false,[false true],...
  'RCSE_corr_time0',0,[-Inf,Inf],...
  'RCSE_corr_time1',170,[-Inf,Inf],...
  'RCSE_best_retmap_prefix',[],[],...
  'RCSE_err_prefix',[],[],...
  'RCSE_rf_niters',0,[0,Inf],...
  'RCSE_rf_min_sizes',[0.1,0.1,0.1],[0.01,10],...
  'RCSE_rf_max_sizes',[3,3,3],[0.01,10],...
  'RCSE_rf_min_slopes',[0,0,0],[0,10],...
  'RCSE_rf_max_slopes',[0.2,0.2,0.2],[0,10],...
  'RCSE_rf_size_step',0.1,[0.01,10],...
  'RCSE_rf_slope_step',0.01,[0.001,1],...
  'RCSE_calc_scalefacts_flag',false,[false true],...
  'RCSE_bem_flag',true,[false true],...
  'RCSE_openmeeg_flag',false,[false true],...
  'RCSE_conductivities',[0.3 0.012 0.3],[],...
  'RCSE_EEG_gain_scalefact',1,[-Inf Inf],...
  'RCSE_nlayers',1,[1:4],...
  'RCSE_bem_surf_files',...
    {'bem/inner_skull.tri','bem/outer_skull.tri','bem/outer_scalp.tri'},[],...
  'RCSE_grad_scalefact',10^13,[-Inf Inf],...
  'RCSE_mag_scalefact',10^15,[-Inf Inf],...
  'RCSE_EEG_scalefact',10^6,[-Inf Inf],...
  'RCSE_usegrad_flag',true,[false true],...
  'RCSE_usemag_flag',true,[false true],...
  'RCSE_useEEG_flag',false,[false true],...
  'RCSE_indy_smfact',0.999,[0,1],...
  'RCSE_ecc_smfact',0,[0,1],...
  'RCSE_upperlower_smfact',0,[0,1],...
  'RCSE_hemi_smfact',0,[0,1],...
  'RCSE_loose_flag',false,[false true],...
  'RCSE_loose_tang_weight',0.5,[0,1],...
  'RCSE_condF_thresh',0,[],...
  'RCSE_dip_matfile',[],[],...
  'RCSE_ret_dips_lh_dec_file',[],[],...
  'RCSE_ret_dips_rh_dec_file',[],[],...
  'RCSE_ret_dip_qfield_flag',true,[false true],...
  'RCSE_nonret_dips_lh_dec_file',[],[],...
  'RCSE_nonret_dips_rh_dec_file',[],[],...
  'RCSE_ret_dips_weight',0,[0,1],...
  'RCSE_nonret_dips_weight',0,[0,1],...
  'RCSE_norm_weights_flag',2,[0 1 2 3],...
  'RCSE_area_names',{'v1','v2','v3'},[],...
  'RCSE_area_colors',{'b','g','r'},[],...
  'RCSE_plot_outdir','RCSE_plots',[],...
  'RCSE_plot_normflag',false,[false true],...
  'RCSE_plot_ylim',[-30,30],[-Inf,Inf],...
  'RCSE_save_avg_flag',true,[false true],...
  'RCSE_write_err_flag',false,[false true],...
  'RCSE_write_fit_flag',false,[false true],...
  'RCSE_write_areafit_flag',false,[false true],...
  'RCSE_write_fif_flag',false,[false true],...
  'RCSE_template_fif',[],[],...
... RCSE parameters for group prior
  'RCSE_group_prior_flag',false,[false true],...
  'RCSE_group_prior_prefix','GroupRCSE/RCSE',[],...
  'RCSE_group_prior_niters',500,[0,1e10],...
  'RCSE_group_prior_ProjID',ProjID,[],...
... % dSPM-RCSE options
  'dSRC_rootoutdir',[],[],...
  'dSRC_prefix','dSPM_RCSE',[],...
  'dSRC_outstem','dSPM_RCSE',[],...
  'dSRC_dSPM_prefix','dSPM',[],...
  'dSRC_RCSE_prefix','RCSE',[],...
  'dSRC_RCSE_rootdir',[],[],...
  'dSRC_RCSE_forward_prefix',[],[],...
  'dSRC_RCSE_forward_rootdir',[],[],...
  'dSRC_fiterr_flag',0,[0:3],...
  'dSRC_areas',[],[],...
  'dSRC_conditions',[],[],...
  'dSRC_sourcefact',1,[0,Inf],...
  'dSRC_baselineflag',true,[false true],...
  'dSRC_save_synth_flag',false,[false true],...
  'dSRC_fif_flag',false,[false true],...
  'dSRC_template_fif',[],[],...
  'dSRC_write_mgh_flag',false,[false true],...
  'dSRC_ncov_type',2,[0:2],...
  'dSRC_calc_scalefacts_flag',false,[false true],...
  'dSRC_ROI_outdir','dSRC_ROI_analysis',[],...
  'dSRC_ROI_outstem','dSRC_ROI_results',[],...
  'dSRC_forceflag',false,[false true],...
...% synth-RCSE options
  'SRC_rootoutdir',[],[],...
  'SRC_outstem','synth_RCSE',[],...
  'SRC_prefix','RCSE',[],...
  'SRC_forward_prefix',[],[],...
  'SRC_rootdir',[],[],...
  'SRC_forward_rootdir',[],[],...
  'SRC_fiterr_flag',0,[0:3],...
  'SRC_areas',[],[],...
  'SRC_sourcefact',1,[-Inf,Inf],...
  'SRC_baselineflag',false,[false true],...
  'SRC_sources',[],[],...
  'SRC_fif_flag',false,[false true],...
  'SRC_template_fif',[],[],...
  'SRC_conditions',[],[],...
  'SRC_forceflag',false,[false true],...
...
  'required_containers',{'proc_meg','fsurf'},[],...
};
parms = mmil_args2parms(varargin,parms_filter);

% excl_tags are fields that should not be passed to MMIL_Analyze_MEG_Exam
excl_tags = {'RootDirs' 'StudyInfo' 'qcflag' 'batchname' 'batch_append_flag'...
  'batch_msg_flag' 'forceflag' 'dSPM_ico' 'RCSE_group_prior_flag'...
  'RCSE_group_prior_prefix' 'RCSE_group_prior_niters' ...
  'RCSE_group_prior_ProjID' 'required_containers'};
tags = setdiff(fieldnames(parms),excl_tags);

if parms.dSPMflag && parms.dSPM_ico
  fsico_type = 'fsico';
  fsico_type = sprintf('%s%d',fsico_type,parms.dSPM_ico);
  parms.required_containers = union(parms.required_containers,{'fsico'});
  parms.ico = parms.dSPM_ico; % for MMIL_Check_ProjID
end;

if parms.RCSEflag
  parms.required_containers = union(parms.required_containers,'proc_bold');
end;

args = MMIL_Args(parms,'MMIL_Check_ProjID');
[ProjInfo,StudyInfo,RootDirs] = MMIL_Check_ProjID(ProjID,args{:});
if ~isempty(ProjInfo)
  % For arg names present in both varargin and ProjInfo
  % the varargin values will appear in merged_args
  ProjInfo_args = MMIL_Args(ProjInfo,mfilename);
  merged_args = mmil_merge_args(varargin,ProjInfo_args);
  % check that parameters fit allowed range, use defaults if not supplied
  parms = mmil_args2parms(merged_args,parms_filter);
end;

% if not supplied, use dSPM values for some dSROI parameters
if isempty(parms.dSROI_ico), parms.dSROI_ico = parms.dSPM_ico; end;
if isempty(parms.dSROI_prefix), parms.dSROI_prefix = parms.dSPM_prefix; end;

% set individual forceflags
if parms.forceflag
  parms.dSPM_forceflag = parms.forceflag; % may be 2 to overwrite forward
  parms.dSROI_forceflag = 1;
  parms.RCSE_forceflag = parms.forceflag; % may be 2 to overwrite forward
  parms.dSRC_forceflag = 1;
  parms.SRC_forceflag = 1;
end;

% set location of group prior
if parms.RCSE_group_prior_flag
  parms.RCSE_prior_prefix = sprintf('%s/MetaData/%s/%s',...
    RootDirs.home,parms.RCSE_group_prior_ProjID,parms.RCSE_group_prior_prefix);
  if parms.RCSE_offset_niters==0
    parms.RCSE_offset_niters = parms.RCSE_group_prior_niters;
  end;
%  parms.RCSE_reweight_flag = 0;
end;

% set dSROI_subjdir (location of FS recon with labels)
if isempty(parms.dSROI_subjdir)
  if parms.dSROI_ico
    parms.dSROI_subjdir = RootDirs.fsico;
  else
    parms.dSROI_subjdir = RootDirs.fsurf;
  end;
end;

% create output batch directory
if ~isempty(ProjID)
  parms.batchname = [ProjID '_' parms.batchname];
end;
batchdir = [RootDirs.batch '/' parms.batchname];
scriptlistfname = sprintf('%s/scriptlist.txt',batchdir);
if exist(batchdir,'dir') && ~parms.batch_append_flag
  cmd = sprintf('rm -rf %s/*\n',batchdir);
  fprintf('cmd = %s',cmd);
  unix(cmd);
end;
mmil_mkdir(batchdir);

if parms.batch_append_flag
  fid = fopen(scriptlistfname,'a');
  if fid==-1
    error('failed to open scriptlist file %s for appending\n',scriptlistfname);
  end;
  fclose(fid);
  % read file, get last job number
  try
    joblist = mmil_readtext(scriptlistfname);
  catch
    joblist = [];
  end;
  if isempty(joblist)
    j = 1;
  else
    jobID = joblist{end};
    n = regexp(jobID,'job_(?<jobnum>\d+)','names');
    if isempty(n)
      error('failed to read job number from %s',scriptlistfname);
    end;
    j = str2num(n.jobnum) + 1;
  end;
else
  fid = fopen(scriptlistfname,'w');
  if fid==-1
    error('failed to open scriptlist file %s for writing\n',scriptlistfname);
  end;
  fclose(fid);
  j=1;
end;

% create jobs for each subject in StudyInfo
qmatjobsnum = 1;
for i=1:length(StudyInfo)
  SubjID = StudyInfo(i).SubjID;
  VisitID = StudyInfo(i).VisitID;
  MEG_VisitID = StudyInfo(i).MEG_VisitID;
  if isfield(StudyInfo,'Prior_MEG_VisitID')
    Prior_MEG_VisitID = StudyInfo(i).Prior_MEG_VisitID;
  else
    Prior_MEG_VisitID = [];
  end;
  if isempty(Prior_MEG_VisitID)
    Prior_MEG_VisitID = MEG_VisitID;
  end;
  ContainerPath = sprintf('%s/%s',RootDirs.proc_meg,StudyInfo(i).proc_meg);
  FSContainerPath = sprintf('%s/%s',RootDirs.fsurf,StudyInfo(i).fsurf);
  if parms.dSPMflag && parms.dSPM_ico
    ico_FSContainerPath = ...
      sprintf('%s/%s',RootDirs.fsico,StudyInfo(i).(fsico_type));
  else
    ico_FSContainerPath = [];
  end;

  % replace values in parms with (non-empty) values from StudyInfo
  tmp_parms = parms;
  for t=1:length(tags)
    tmp_val = mmil_getfield(StudyInfo(i),tags{t},[]);
    if ~isempty(tmp_val), tmp_parms.(tags{t}) = tmp_val; end;
  end;

  % set full path of prior prefix
  if ~parms.RCSE_group_prior_flag && ~isempty(parms.RCSE_prior_prefix) &&...
    (parms.RCSE_offset_niters>0 || parms.RCSE_nbrhd_niters>0)
    % self-prior
    if mmil_isrelative(parms.RCSE_prior_prefix) &&...
       ~strcmp(Prior_MEG_VisitID,MEG_VisitID)
      Prior_ContainerPath = MMIL_Get_Container(RootDirs,Prior_MEG_VisitID,...
        'proc_meg');
      tmp_parms.RCSE_prior_prefix = sprintf('%s/matfiles/%s',...
        Prior_ContainerPath,parms.RCSE_prior_prefix);
    end;
  end;

  if ~any([tmp_parms.dSPMflag,tmp_parms.dSROIflag,...
           tmp_parms.RCSEflag,tmp_parms.dSRCflag,tmp_parms.SRCflag]==1)
    continue;
  end;

  % cond_info file could be in ProjInfo or ContainerPath
  if tmp_parms.RCSEflag && mmil_isrelative(tmp_parms.RCSE_fstem_conds)
    tmp_fstem = [ContainerPath '/' parms.RCSE_fstem_conds];
    if exist([tmp_fstem '.csv'],'file')
      tmp_parms.RCSE_fstem_conds = tmp_fstem;
    else
      tmp_fstem = [RootDirs.home '/ProjInfo/' ProjID '/'...
        tmp_parms.RCSE_fstem_conds];
      if exist([tmp_fstem '.csv'],'file')
        tmp_parms.RCSE_fstem_conds = tmp_fstem;
      else
        fprintf('%s: WARNING: subject %s is missing cond_info file %s.csv for RCSE\n',...
          mfilename,SubjID,parms.RCSE_fstem_conds);
        tmp_parms.RCSEflag = 0;
      end;
    end;
  end;
  if tmp_parms.RCSEflag || tmp_parms.dSRCflag || tmp_parms.SRCflag, qmatjobsnum = 2; end;

  tmp_parms.dSPM_ico_FSContainerPath = ico_FSContainerPath;
  if ~parms.dSROI_ico
    tmp_parms.dSROI_subjname = StudyInfo(i).fsurf;
  end;

  if tmp_parms.RCSEflag
    RETContainerPath = sprintf('%s/%s',RootDirs.proc_bold,StudyInfo(i).proc_bold);
    tmp_parms.RCSE_retfit_dir = [RETContainerPath '/' tmp_parms.RCSE_retfit_dir];
    if ~exist(tmp_parms.RCSE_retfit_dir,'dir')
      fprintf('%s: WARNING: retfit dir %s not found (disabling RCSE)\n',...
        mfilename,tmp_parms.RCSE_retfit_dir);
      tmp_parms.RCSEflag = 0;
    end;
  end;
  jstem = regexprep(MEG_VisitID,'\^','_');
  jstem = jstem(1:min(20,length(jstem)));
  jobID = sprintf('job_%03d_%s',j,jstem); j = j+1;
  jobfname = sprintf('%s/%s.m',batchdir,jobID);
  mmil_write_script(jobfname,'MMIL_Analyze_MEG_Exam',...
    {ContainerPath,FSContainerPath},tags,tmp_parms);
  fid = fopen(scriptlistfname,'a');
  fprintf(fid,'%s\n',jobID);
  fclose(fid);
end

if parms.batch_msg_flag
  fprintf('%%%% Now login to a cluster and run this:\n');
  if qmatjobsnum>1
    fprintf('    qmatjobs%d %s\n',qmatjobsnum,parms.batchname);
  else
    fprintf('    qmatjobs %s\n',parms.batchname);
  end;
end;

